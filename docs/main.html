<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baskit Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bree+Serif&family=Quicksand&display=swap" rel="stylesheet" />
</head>
<body class="main-body">
  <header class="main-header">
    <img src="images/logo.png" alt="Logo" class="main-logo" />
    <h1 class="main-greeting">Happy Shopping, <span id="user-name">Friend!</span>!</h1>
  </header>

  <nav class="main-nav">
    <div class="nav-container">
    <ul>
      <li><a href="#">OLD LISTS</a></li>
      <li><a href="#">RECIPES</a></li>
      <li><a href="#">TEMPLATES</a></li>
      <li><a href="profile.html">PROFILE</a></li>
    </ul>
    <button id="logout-btn" class="logout-btn">LOGOUT</button>
    </div>
  </nav>

  <main class="main-content">
    <!-- Left side: 75% -->
    <section class="main-left">
      <!-- B1 -->
      <div class="box box-b1">
        <h2>Current List</h2>
        <div class="list-columns" id="grocery-list">
        </div>
        <div class="shop-list-container">
            <button id="shop-button">Shop Your List</button>
          </div>
        <form id="addItemForm" class="add-item-form">
          <input type="text" id="item-name" placeholder="Item" maxlength="25" required />
          <input type="number" id="item-qty" placeholder="Qty" min="1" />
          <button type="submit">Add</button>
        </form>
      </div>

      <!-- Suggestions -->
      <div class="suggestions">Here's where your suggestions will go. Lorem ipsum and nonsense for now.</div>

      <!-- B2 -->
      <div class="box box-b2">
        <div class="box-b2-left">
          <h3>B2</h3>
        </div>
        <div class="box-b2-right">
          <!-- Blank for now -->
        </div>
      </div>
    </section>

    <!-- Right side: 25% -->
    <aside class="main-right">
        <div class="box box-b3">
            <h2>Quick Add</h2>
            <div id="b3-feedback" class="b3-feedback"></div> 
            <form id="addItemFormB3" class="add-item-form">
              <input type="text" id="item-name-b3" placeholder="Item" />
              <input type="number" id="item-qty-b3" placeholder="Qty" min="1" />
              <button type="submit">Add</button>
            </form>
          </div>

          <div class="box box-b4">
            <h2>Meal Planner</h2>
            <div id="meal-planner">
              <!-- Days will be injected here dynamically -->
            </div>
          </div>

      <!--<div class="box box-b5">
        <h2>B5</h2>
      </div>
    </aside>
  </main> -->

  <script>
    // Grab user's first name from storage
    let userData = null;
try {
  const raw = localStorage.getItem("user");
  if (raw && raw !== "undefined") {
    userData = JSON.parse(raw);
  }
} catch (e) {
  console.error("Failed to parse user from localStorage:", e);
}
if (userData && userData.firstName) {
  document.getElementById("user-name").textContent = userData.firstName;
}
  </script>
</body>
</html>

<script>
    const listContainer = document.getElementById('grocery-list');
    const addItemForm = document.getElementById('addItemForm');
    const itemNameInput = document.getElementById('item-name');
    const itemQtyInput = document.getElementById('item-qty');
  
    function getCurrentUser() {
  try {
    const rawUser = localStorage.getItem('user');
    if (!rawUser || rawUser === 'undefined') return 'guest'; // avoid JSON.parse crash
    const user = JSON.parse(rawUser);
    return user?.username || 'guest';
  } catch (e) {
    console.error('Failed to parse user:', e);
    return 'guest';
  }
}

    function getList() {
        const key = `groceryList_${getCurrentUser()}`;
        return JSON.parse(localStorage.getItem(key)) || [];
    }

    function saveList(list) {
        const key = `groceryList_${getCurrentUser()}`;
        localStorage.setItem(key, JSON.stringify(list));
    }
  
    function renderList() {
      const list = getList();
      console.log("Rendering list for: ", getCurrentUser());
      listContainer.innerHTML = '';
  
      if (list.length === 0) {
        listContainer.innerHTML = `
            <div class="empty-wrapper">
                <div class="empty-list">
                    <p>YOUR LIST IS EMPTY!<br>BETTER START SHOPPING!</p>
                    <img src="images/cat3.png" alt="Empty" />
                </div>
            </div>
`;
        return;
      }
  
      const col1 = document.createElement('div');
const col2 = document.createElement('div');
const col3 = document.createElement('div');
col1.classList.add('list-column');
col2.classList.add('list-column');
col3.classList.add('list-column');

list.forEach((item, index) => {
  const itemDiv = document.createElement('div');
  itemDiv.className = 'item';

  itemDiv.innerHTML = `
  <div class="qty-block">
    <span class="qty-label">${item.qty > 1 ? item.qty : ''}</span>
    <div class="divider"></div>
    <span class="item-name" title="${item.name}">${item.name}</span>
  </div>
  <div class="qty-controls">
    <button onclick="changeQty(${index}, -1)">−</button>
    <button onclick="changeQty(${index}, 1)">+</button>
  </div>
`;

  if (index % 3 === 0) {
    col1.appendChild(itemDiv);
  } else if (index % 3 === 1) {
    col2.appendChild(itemDiv);
  } else {
    col3.appendChild(itemDiv);
  }
});

listContainer.appendChild(col1);
listContainer.appendChild(col2);
listContainer.appendChild(col3);
    }
  
    function changeQty(index, change) {
        const list = getList();
        const currentQty = list[index].qty || 1;
        const newQty = currentQty + change;

        if (newQty < 1) {
            list.splice(index, 1); 
         } else {
            list[index].qty = Math.min(newQty, 99); // max of 99
        }
        console.log("Saving for:", getCurrentUser());
        saveList(list);
        renderList();
    }
    console.log("Current user:", getCurrentUser());
    addItemForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = itemNameInput.value.trim();
      let qty = parseInt(itemQtyInput.value.trim(), 10);
      if (!name) return;
  
      if (isNaN(qty) || qty < 1) qty = 1;
  
      const list = getList();
      list.push({ name, qty });
      saveList(list);
  
      itemNameInput.value = '';
      itemQtyInput.value = '';
      renderList();
    });

    const addItemFormB3 = document.getElementById('addItemFormB3');
const itemNameInputB3 = document.getElementById('item-name-b3');
const itemQtyInputB3 = document.getElementById('item-qty-b3');

addItemFormB3.addEventListener('submit', (e) => {
  e.preventDefault();
  const name = itemNameInputB3.value.trim();
  let qty = parseInt(itemQtyInputB3.value.trim(), 10);
  if (!name) return;

  if (isNaN(qty) || qty < 1) qty = 1;

  const list = getList();
  list.push({ name, qty });
  saveList(list);

  itemNameInputB3.value = '';
  itemQtyInputB3.value = '';
  renderList();

  const feedback = document.getElementById('b3-feedback');
  feedback.textContent = 'Added!';
  feedback.classList.add('visible');

  setTimeout(() => {
    feedback.textContent = '';
    feedback.classList.remove('visible');
  }, 1500);
});
document.getElementById("logout-btn").addEventListener("click", () => {
  localStorage.removeItem("user");
  localStorage.removeItem("token");
  window.location.href = "login.html";
});
    // Initialize on page load
    renderList();

    //Meal Planning Logic


    async function fetchMealPlan() {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch('https://smart-shopping-api-1k1z.onrender.com/mealplan', {
      headers: { Authorization: `Bearer ${token}` }
    });

    const data = await res.json();
    return data.week || {};
  } catch (err) {
    console.error('Fetch failed:', err);
    return {}; // fallback to render empty state
  }
}

// Initialize
fetchMealPlan()
  .then(renderMealPlanner)
  .catch(err => {
    console.error('Unexpected error:', err);
    renderMealPlanner(); // fallback if something breaks
  });

async function saveMealPlan(updatedWeek) {
  const token = localStorage.getItem("token");
  const user = JSON.parse(localStorage.getItem("user"));
  const username = user?.username || "guest";

  await fetch(`https://smart-shopping-api-1k1z.onrender.com/mealplan/${username}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${token}`
    },
    body: JSON.stringify({ week: updatedWeek })
  });
}

const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
const plannerContainer = document.getElementById('meal-planner');

function renderMealPlanner(weekData) {
  const plannerContainer = document.getElementById('meal-planner');
  plannerContainer.innerHTML = '';

  daysOfWeek.forEach(day => {
    const meals = weekData[day] || ["", "", "", ""];

    const dayDiv = document.createElement('div');
    dayDiv.className = 'meal-day';

    const header = document.createElement('div');
    header.className = 'meal-header';
    header.innerHTML = `${day} <span class="expand-btn">+</span>`;

    const body = document.createElement('div');
    body.className = 'meal-body';

    meals.forEach((meal, index) => {
      const line = document.createElement('div');
      line.className = 'meal-line';

      const bullet = document.createElement('span');
      bullet.textContent = '•';

      const underline = document.createElement('input');
      underline.type = 'text';
      underline.value = meal;
      underline.placeholder = '';
      underline.className = 'meal-input';

      underline.addEventListener('change', () => {
        weekData[day][index] = underline.value;
        saveMealPlan(weekData);
      });

      line.appendChild(bullet);
      line.appendChild(underline);
      body.appendChild(line);
    });

    header.addEventListener('click', () => {
  const isOpen = body.style.display === 'flex';

  document.querySelectorAll('.meal-body').forEach(el => {
    el.style.display = 'none';
  });

  if (!isOpen) {
    body.style.display = 'flex';
  }
});

    dayDiv.appendChild(header);
    dayDiv.appendChild(body);
    plannerContainer.appendChild(dayDiv);
  });
}

// Initialize
fetchMealPlan().then(renderMealPlanner);

document.getElementById("shop-button").addEventListener("click", async () => {
  const user = JSON.parse(localStorage.getItem("user"));
  const key = `groceryList_${user.username}`;
  const list = JSON.parse(localStorage.getItem(key)) || [];

  const res = await fetch('https://smart-shopping-api-1k1z.onrender.com/shop', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ list })
  });

  const data = await res.json();
  localStorage.setItem('shopResults', JSON.stringify(data));
  window.location.href = 'shop-results.html';
});

document.getElementById('shop-list-btn').addEventListener('click', async () => {
  const user = JSON.parse(localStorage.getItem('user'));
  const token = localStorage.getItem('token');
  const listKey = `groceryList_${user?.username}`;
  const groceryList = JSON.parse(localStorage.getItem(listKey)) || [];
  const preferredStores = JSON.parse(localStorage.getItem(`storePrefs_${user?.username}`)) || [];

  if (!groceryList.length || !preferredStores.length) {
    alert("Make sure you have a list and preferred stores selected.");
    return;
  }

  try {
    const res = await fetch('https://smart-shopping-api-1k1z.onrender.com/shop', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ list: groceryList, stores: preferredStores })
    });

    const result = await res.json();
    console.log('Price comparison:', result);
    // You can redirect or populate a new results section here later.
    alert("Check the console for price comparison results (mock data for now).");

  } catch (err) {
    console.error("Shop error:", err);
    alert("Something went wrong with the comparison.");
  }
});
  </script>